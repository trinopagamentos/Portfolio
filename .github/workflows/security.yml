name: Security Scan

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        run: semgrep scan --config p/owasp-top-ten --config p/security-audit --config p/secrets --error --json > semgrep-results.json || true

      - name: Check results
        run: |
          if [ -f semgrep-results.json ]; then
            FINDINGS=$(cat semgrep-results.json | python3 -c "import sys,json; print(len(json.load(sys.stdin).get('results',[])))" 2>/dev/null || echo "0")
            echo "Semgrep found $FINDINGS finding(s)"
            semgrep scan --config p/owasp-top-ten --config p/security-audit --config p/secrets --error
          fi

  gitleaks:
    name: Gitleaks Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
